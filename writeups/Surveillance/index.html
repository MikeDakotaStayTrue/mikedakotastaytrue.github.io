<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Surveillance | mikedakotastaytrue </title> <meta name="author" content="mikedakotastaytrue "> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="shortcut icon" type="image/png" href="/assets/img/favicon.png"> <link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&amp;family=Reddit+Mono&amp;display=swap" rel="stylesheet"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img//assets/img/favicon.png"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://alshedivat.github.io/writeups/Surveillance/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">mikedakotastaytrue </span></a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/posts/">posts</a> </li> <li class="nav-item "> <a class="nav-link" href="/writeups/">writeups</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Surveillance</h1> <p class="post-description"></p> </header> <article> <p>Port scanning result:</p> <ul> <li>22 (ssh)</li> <li>80 (web)</li> <li>1863 (filtred or fp)</li> <li>7100 (filtred or fp)</li> </ul> <p>Add machine address to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> as <strong>surveillance.htb</strong> and let’s get started.</p> <h2 id="foothold">Foothold</h2> <p>It’s a default landing web page, but useful browser extension <a href="https://www.wappalyzer.com" rel="external nofollow noopener" target="_blank">Wappalyzer</a> specified CraftCMS.</p> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_landing_page.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Also, that information can be found in footer of landing page - <a href="https://github.com/craftcms/cms/tree/4.4.14" rel="external nofollow noopener" target="_blank">LINK</a>. CraftCMS is a “flexible, user-friendly CMS for creating custom digital experiences on the web and beyond”, and written in PHP. Google some CVEs and security issues, and it will be found a CVE-2023-41892.</p> <h3 id="cve-2023-41892">CVE-2023-41892</h3> <p>CVE-2023-41892 is Unanticated RCE for CraftCMS. This is a high-impact, low-complexity attack vector. Users running Craft installations before 4.4.15 are encouraged to update to at least that version to mitigate the issue. This issue has been fixed in Craft CMS 4.4.15.</p> <p>There is really good description of that CVE on Calif’s <a href="https://blog.calif.io/p/craftcms-rce" rel="external nofollow noopener" target="_blank">blog</a>.</p> <p>In short, one of controller class contains method (beforeAction) with object creation and some gadget chains can do some destruct action, including arbitrary file inclusion.</p> <p>Later, for detect vulnerability it can be used to call arbitrary method, like phpinfo via \GuzzleHttp\Psr7\FnStream.<br> Or, to achive RCE via arbitrary PHP file inclusion using Imagick class chain.<br> Our version is 4.4.14 and it means that it’s vulnerable.</p> <h2 id="user">User</h2> <p>First, lets inject “phpinfo” method to be confident that exploit can be executed successfully.</p> <pre><code class="language-HTTP">POST / HTTP/1.1
Host: surveillance.htb
User-Agent: &lt;UA&gt;
Accept-Encoding: gzip, deflate, br
Accept: */*
Connection: close
Content-Length: 233
Content-Type: application/x-www-form-urlencoded

action=conditions/render&amp;test[userCondition]=craft\elements\conditions\users\UserCondition&amp;config={"name":"test[userCondition]","as+xyz":{"class":"\\GuzzleHttp\\Psr7\\FnStream","__construct()":[{"close":null}],"_fn_close":"phpinfo"}}
</code></pre> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_phpinfo.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>It could be useful to get some information, MySQL credentials, secret key, but we are going to do reverse shell.</p> <p>PoC i <a href="https://gist.github.com/to016/b796ca3275fa11b5ab9594b1522f7226" rel="external nofollow noopener" target="_blank">found</a> was unstable for me, but working.</p> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_craft_revshell2.png" class="img-fluid rounded z-depth-1 col-md-12" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_craft_revshell.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Without linpeas, little manual enumeration and found database backup file - surveillance–2023-10-17-202801–v4.4.14.sql.zip. Let’s download it and discover zipped data.</p> <p>Here is a hashed (SHA256) password of matthew user - crack it, get SSH shell and obtain user flag.</p> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_crack.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_user_obtain.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h2 id="root">Root</h2> <p>linpeas.sh will give a huge hint about one service - ZoneMinder. In the instance, nginx config will disclosure needed information.</p> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_zoneminder_nginx.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Moreover, linpeas greps password from config files.</p> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_zoneminder_pass.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Some googling about that service - CVE-2023-26035.</p> <h3 id="cve-2023-41892-1">CVE-2023-41892</h3> <p>CVE-2023-41892 is Unauthenticated RCE via Missing Authorization in ZoneMinder vulnerability.<br> There are no permissions check on the snapshot action, which expects an id to fetch an existing monitor but can be passed an object to create a new one instead. TriggerOn ends up calling shell_exec using the supplied Id.</p> <p>Problem was fixed by adding validation to Monitor ID and require authentication before processing actions. In addition, validate Monitor ID before calling shell commands.</p> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_github_commits.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Let’s do some pivoting for comfort:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-L</span> 1234:localhost:8080 matthew@surveillance.htb
</code></pre></div></div> <p>As we have an SSH connection, we can use it for port forwarding. Local port 8080 of victim host will forward to our 1234 port. That’s why it could be possible to use <a href="https://github.com/rvizx/CVE-2023-26035" rel="external nofollow noopener" target="_blank">PoC</a> on local machine:</p> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_web_pivot.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Check sudoers rules:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> <span class="nt">-l</span>
</code></pre></div></div> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_sudo.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>As we can see, we can run Perl scripts (.pl) using any name, started with “zm” and located in /usr/bin/*. Grep these Perl scripts in directory and do some research about PrivEsc vectors in them.</p> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_perlscript_grep.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>It seems no regex vulnerability but it maybe legal Perl script way to privilege escalation. Research some documentation and tring to find some suspectios scripts: https://zoneminder.readthedocs.io/en/latest/userguide/components.html#perl</p> <p>Some googling and research will tell about zmupdate.pl.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>zmupdate.pl <span class="nt">--version</span><span class="o">=</span>1 <span class="nt">--user</span><span class="o">=</span><span class="s1">'$(/tmp/exploit.sh)'</span> <span class="nt">--pass</span><span class="o">=</span>ZoneMinderPassword2023
</code></pre></div></div> <p>Bash script in /tmp/exploit.sh will run with root privilegies. Ive just write reading root flag and save to tmp directory.</p> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_run_privesc.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Finnaly, getting root flag:</p> <figure> <picture> <img src="/assets/img/writeups/hackthebox/Surveillance/surveillance_getting_root_flag.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </article> </div> </div> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>